<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Annotation Results</title>

  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
  />
  <!-- Buttons extension CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"
  />

  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td {
      padding: 5px 10px;
    }
    a {
      text-decoration: none;
      color: blue;
    }
    a:hover {
      text-decoration: underline;
    }
    tr:hover {
      background-color: #f0f0f0;
      cursor: pointer;
    }
    /* Ensure container can scroll horizontally */
    div.dataTables_wrapper {
      width: 100%;
      overflow-x: auto;
    }

    /* Container for side-by-side charts */
    .charts-container {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 40px;
      margin-left: auto;
      margin-right: auto;
      gap: 20px; /* space between charts */
    }

    /* Each canvas gets roughly a third of container width */
    .chart-canvas {
      flex: 1 1 32%;
      height: 300px;
    }
  </style>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JS -->
  <script
    src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"
  ></script>

  <!-- Buttons extension JS and dependencies -->
  <script
    src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"
  ></script>
  <script
    src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"
  ></script>
  <script
    src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"
  ></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>Annotated Variants</h2>

  <table id="variantsTable" class="display" style="width:100%">
    <thead>
      <tr>
        {% for col in variants[0].keys() %}
          <th>{{ col }}</th>
        {% endfor %}
        <th>External Links</th>
      </tr>
    </thead>
    <tbody>
      {% for variant in variants %}
      <tr onclick="jumpToBrowser('{{ variant['Chr'] }}', {{ variant['Start'] }}, {{ variant['End'] if 'End' in variant else variant['Start'] }})" style="cursor:pointer;">
        {% for key, val in variant.items() %}
          <td>{{ val }}</td>
        {% endfor %}
        <td>
          {% set chr = variant['Chr'] %}
          {% set start = variant['Start'] %}
          {% set end = variant['End'] if 'End' in variant else variant['Start'] %}
          {% set variant_id = variant.get('VariantID', '') %}

          {% set ucsc_url = 'https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg38&position=chr' ~ chr ~ ':' ~ start ~ '-' ~ end %}
          {% set ensembl_url = 'https://www.ensembl.org/Homo_sapiens/Location/View?r=' ~ chr ~ ':' ~ start ~ '-' ~ end %}
          {% set clinvar_url = 'https://www.ncbi.nlm.nih.gov/clinvar/variation/' ~ variant_id if variant_id else '' %}
          {% set dbsnp_url = 'https://www.ncbi.nlm.nih.gov/snp/' ~ variant_id if variant_id else '' %}
          {% set gnomad_url = 'https://gnomad.broadinstitute.org/variant/chr' ~ chr ~ '-' ~ start %}

          <a href="{{ ucsc_url }}" target="_blank" title="View in UCSC Genome Browser">UCSC</a> |
          <a href="{{ ensembl_url }}" target="_blank" title="View in Ensembl Genome Browser">Ensembl</a>
          {% if clinvar_url %}
            | <a href="{{ clinvar_url }}" target="_blank" title="View in ClinVar">ClinVar</a>
          {% endif %}
          {% if dbsnp_url %}
            | <a href="{{ dbsnp_url }}" target="_blank" title="View in dbSNP">dbSNP</a>
          {% endif %}
          | <a href="{{ gnomad_url }}" target="_blank" title="View in gnomAD">gnomAD</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3>Variant Distribution by Chromosome</h3>
  <div class="charts-container">
    <canvas id="variantChart" class="chart-canvas"></canvas>
    <canvas id="variantPieChart" class="chart-canvas"></canvas>
    <canvas id="scatterPlot" class="chart-canvas"></canvas>
  </div>

  <script>
    $(document).ready(function () {
      $('#variantsTable').DataTable({
        pageLength: 25,
        order: [], // Disable initial ordering
        scrollX: true, // Enable horizontal scrolling
        dom: 'Bfrtip', // Show buttons, filter input, and table
        buttons: [
          'copy', 'csv', 'excel', 'pdf', 'print'
        ]
      });
    });

    const variantCounts = {{ variant_counts | tojson }};
    const labels = Object.keys(variantCounts);
    const data = Object.values(variantCounts);

    // Bar Chart
    const ctxBar = document.getElementById('variantChart').getContext('2d');
    const variantChart = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Variants',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: false,
        scales: {
          y: { beginAtZero: true, precision: 0 },
          x: { title: { display: true, text: 'Chromosome' } }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // Pie Chart
    const ctxPie = document.getElementById('variantPieChart').getContext('2d');
    const variantPieChart = new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Variant Distribution',
          data: data,
          backgroundColor: labels.map(() => `hsl(${Math.random() * 360}, 70%, 60%)`),
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            position: 'right'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                return `${label}: ${value} variant${value !== 1 ? 's' : ''}`;
              }
            }
          }
        }
      }
    });

    // Scatter Plot
    const variantsData = {{ variants | tojson }};

    function chrToNumber(chr) {
      if (chr.match(/^chr/i)) chr = chr.replace(/^chr/i, '');
      if (chr === 'X') return 23;
      if (chr === 'Y') return 24;
      if (chr === 'MT' || chr === 'M') return 25;
      return Number(chr) || 0;
    }

    const scatterDataPoints = variantsData.map(v => ({
      x: v.Start,
      y: chrToNumber(v.Chr),
    }));

    const ctxScatter = document.getElementById('scatterPlot').getContext('2d');
    const scatterChart = new Chart(ctxScatter, {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Variant Positions',
          data: scatterDataPoints,
          backgroundColor: 'rgba(255, 99, 132, 0.7)',
        }]
      },
      options: {
        responsive: false,
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: {
              display: true,
              text: 'Variant Start Position'
            }
          },
          y: {
            type: 'linear',
            title: {
              display: true,
              text: 'Chromosome Number'
            },
            ticks: {
              stepSize: 1,
              callback: function(value) {
                if (value === 23) return 'X';
                if (value === 24) return 'Y';
                if (value === 25) return 'MT';
                return value;
              }
            },
            min: 0,
            max: 26
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    function jumpToBrowser(chr, start, end) {
      alert(`Clicked variant location: chr${chr}:${start}-${end}`);
    }
  </script>
</body>
</html>
